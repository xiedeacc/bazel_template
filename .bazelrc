common --noenable_bzlmod
common --experimental_downloader_config=.bazel_downloader.cfg

######################### attention #########################
# 1. static link tcmalloc or jemalloc with folly will coredump
# 2. pprof.out generated in bazel test sandbox
# 3. go install github.com/google/pprof@latest
# 4. both tcmalloc and jemalloc cannot detect memory leak, use sanitize instead
# 5. clang need link -static-libasan

test:cpplint --test_tag_filters='cpplint'
test:cpplint --build_tests_only
test:unit_test --test_tag_filters='-cpplint'

test:unit_test_tcmalloc --define='profiling_type=tcmalloc'
test:unit_test_tcmalloc --test_env='CPUPROFILE=pprof.out'
test:unit_test_tcmalloc --test_env='PPROF_PATH=/root/src/go/bin/pprof'
test:unit_test_tcmalloc --copt='-g'

test:unit_test_jemalloc --define='profiling_type=jemalloc'
test:unit_test_jemalloc --test_env='CPUPROFILE=pprof.out'
test:unit_test_jemalloc --test_env='PPROF_PATH=/usr/local/bin/pprof'
test:unit_test_jemalloc --test_env='MALLOC_CONF=prof_leak:true,prof:true,prof_active:true,lg_prof_interval:20,lg_prof_sample:17,prof_prefix:jeprof.out,prof_final:true'
test:unit_test_jemalloc --copt='-g'

# -fsanitize=address,undefined,thread,memory
test:sanitize --copt='-fno-omit-frame-pointer'
test:sanitize --copt='-fsanitize=address'
test:sanitize --copt='-O1'
test:sanitize --copt='-g'
test:sanitize --linkopt='-fsanitize=address'
#test:sanitize --linkopt='-static-libasan'

coverage --test_tag_filters=-cpplint
coverage --copt=--coverage
coverage --copt=-fprofile-arcs
coverage --copt=-ftest-coverage
coverage --copt='-g'
coverage --linkopt=-coverage
coverage --nocache_test_results

#####################################################################
build --announce_rc
build --workspace_status_command=bazel/workspace_status.sh

build -c opt
#build --copt='-g'
build --copt='-O2'
build --copt='-Wall'
build --cxxopt='-std=c++17'
build --cxxopt=-D_GLIBCXX_USE_CXX11_ABI=1

#build --host_copt='-g'
build --host_copt='-O2'
build --host_copt='-Wall'
build --host_cxxopt='-std=c++17'
build --host_cxxopt=-D_GLIBCXX_USE_CXX11_ABI=1

build --strip='never'
build --output_filter="^//"

#build --features=-compiler_param_file
#build --features=-layering_check
#build --host_features=-compiler_param_file
#build --host_features=-layering_check

#build --remote_cache=http://192.168.1.101/bazel_cache
#build --keep_going

build:gcc_local --platforms='//bazel:linux_x86_64_platform'
#build:gcc_local --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
build:gcc_local --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:gcc_local --extra_toolchains='@local_config_cc_toolchains//:cc-toolchain-k8'
build:gcc_local --extra_toolchains='@remotejdk21_linux_toolchain_config_repo//:toolchain'
build:gcc_local --cpu='x86_64'
build:gcc_local --compiler=gcc
#build:gcc_local --java_runtime_version="remotejdk_21"

build:gcc --platforms='//bazel:linux_x86_64_platform'
#build:gcc --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
build:gcc --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:gcc --extra_toolchains='@cc_toolchain_config_x86_64_linux_generic_glibc_gcc//:toolchain-x86_64_linux_generic_glibc_gcc'
build:gcc --extra_toolchains='@remotejdk21_linux_toolchain_config_repo//:toolchain'
build:gcc --cpu='x86_64'
build:gcc --compiler='gcc'
build:gcc --define='profiling_type=jemalloc'
#build:gcc --java_runtime_version="remotejdk_21"

build:gcc_macosx_x86_64 --platforms='//bazel:osx_x86_64_platform'
#build:gcc_macosx_x86_64 --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
build:gcc_macosx_x86_64 --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:gcc_macosx_x86_64 --extra_toolchains='@cc_toolchain_config_x86_64_osx_generic_macosx_gcc//:toolchain-x86_64_osx_generic_macosx_gcc'
build:gcc_macosx_x86_64 --extra_toolchains='@remotejdk21_linux_toolchain_config_repo//:toolchain'
build:gcc_macosx_x86_64 --cpu='x86_64'
build:gcc_macosx_x86_64 --compiler='gcc'
build:gcc_macosx_x86_64 --copt='-mmacosx-version-min=10.13'
#build:gcc_macosx_x86_64 --java_runtime_version="remotejdk_21"

build:openwrt_aarch64 --platforms='//bazel:linux_aarch64_platform'
#build:openwrt_aarch64 --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
build:openwrt_aarch64 --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:openwrt_aarch64 --extra_toolchains='@cc_toolchain_config_aarch64_linux_openwrt_musl_gcc//:toolchain-aarch64_linux_openwrt_musl_gcc'
build:openwrt_aarch64 --extra_toolchains='@remotejdk21_linux_aarch64_toolchain_config_repo//:toolchain'
build:openwrt_aarch64 --cpu='aarch64'
build:openwrt_aarch64 --compiler='gcc'
build:openwrt_aarch64 --java_runtime_version="remotejdk_21"
build:openwrt_aarch64 --action_env=STAGING_DIR=/root/src/software/openwrt/openwrt-aarch64_toolchain

build:clang_local --platforms='//bazel:linux_x86_64_platform'
build:clang_local --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
#build:clang_local --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:clang_local --extra_toolchains='//toolchain:clang_toolchain_for_linux_x86_64'
build:clang_local --extra_toolchains='@remotejdk21_linux_toolchain_config_repo//:toolchain'
build:clang_local --cpu='x86_64'
build:clang_local --compiler=clang
#build:clang_local --java_runtime_version="remotejdk_21"

build:clang --platforms='//bazel:linux_x86_64_platform'
build:clang --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
#build:clang --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:clang --extra_toolchains='@cc_toolchain_config_x86_64_linux_generic_glibc_clang//:toolchain-x86_64_linux_generic_glibc_clang'
build:clang --extra_toolchains='@remotejdk21_linux_toolchain_config_repo//:toolchain'
build:clang --cpu='x86_64'
build:clang --compiler='clang'
build:clang --define='profiling_type=jemalloc'
#build:clang --java_runtime_version="remotejdk_21"

build:clang_aarch64 --platforms='//bazel:linux_aarch64_platform'
build:clang_aarch64 --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
#build:clang_aarch64 --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:clang_aarch64 --extra_toolchains='@cc_toolchain_config_aarch64_linux_generic_glibc_clang//:toolchain-aarch64_linux_generic_glibc_clang'
build:clang_aarch64 --extra_toolchains='@remotejdk21_linux_aarch64_toolchain_config_repo//:toolchain'
build:clang_aarch64 --cpu='aarch64'
build:clang_aarch64 --compiler=clang
#build:clang_aarch64 --java_runtime_version="remotejdk_21"

build:clang_macosx_x86_64 --platforms='//bazel:osx_x86_64_platform'
#build:clang_macosx_x86_64 --toolchain_resolution_debug='@bazel_tools//tools/cpp:toolchain_type'
build:clang_macosx_x86_64 --toolchain_resolution_debug='@bazel_tools//tools/jdk:runtime_toolchain_type'
build:clang_macosx_x86_64 --extra_toolchains='@cc_toolchain_config_x86_64_osx_generic_macosx_clang//:toolchain-x86_64_osx_generic_macosx_clang'
build:clang_macosx_x86_64 --extra_toolchains='@remotejdk21_linux_toolchain_config_repo//:toolchain'
build:clang_macosx_x86_64 --cpu='x86_64'
build:clang_macosx_x86_64 --compiler='clang'
build:clang_macosx_x86_64 --copt='-mmacosx-version-min=10.13'
#build:clang_macosx_x86_64 --java_runtime_version="remotejdk_21"

